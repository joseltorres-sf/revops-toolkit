<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Timelines | RevOps Tools</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Helvetica Neue"', 'Helvetica', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        brand: {
                            base: '#F5F2EB',       /* Main Background */
                            surface: '#EBE6DD',    /* Secondary/Hover */
                            line: '#D4CDC1',       /* Borders/Grid Lines */
                            text: '#3A352F',       /* Primary Text */
                            muted: '#8C857B',      /* Secondary Text */
                            accent: '#A4907C',     /* Accents */
                            forest: '#1F3A2C',     /* Dark Interactive Green */
                            forestTint: '#E6EAE6', /* Light Green Tint */
                        },
                        // Functional Status Colors
                        rust: { DEFAULT: '#C86A58', tint: '#F7EAE8' },
                        brass: '#C29A5B',
                        slate: { DEFAULT: '#5B7B8C', tint: '#EAF0F2' },
                        forest: { 500: '#4A6B56', 700: '#2C4F3B' } 
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F5F2EB;
            color: #3A352F;
            /* Subtle organic noise texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            -webkit-font-smoothing: antialiased;
        }

        /* Hard shadow for main container (Industrial Look) */
        .industrial-shadow {
            box-shadow: 8px 8px 0px 0px rgba(58,53,47,0.05);
        }

        /* Premium Reveal Animations */
        .reveal-up {
            opacity: 0;
            animation: revealUp 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            transform: translateY(40px);
        }
        
        @keyframes revealUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #EBE6DD; }
        ::-webkit-scrollbar-thumb { background: #D4CDC1; border-radius: 0; }
        ::-webkit-scrollbar-thumb:hover { background: #A4907C; }

        /* Remove default input styling */
        input:focus, select:focus, textarea:focus { outline: none; box-shadow: none; }
        
        /* Toast Notification Animations */
        .toast-enter { animation: slideInTop 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .toast-exit { animation: fadeOutTop 0.3s ease-in forwards; }
        @keyframes slideInTop { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOutTop { to { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col p-6 md:p-10 lg:p-16 pt-8 md:pt-10 relative selection:bg-brand-forest selection:text-brand-base">

    <!-- Header Navigation -->
    <div id="main-header" class="w-full max-w-7xl mx-auto mb-8 md:mb-12 flex justify-between items-end reveal-up delay-100 transition-opacity duration-300">
        <div>
            <a href="index.html" class="inline-flex items-center gap-2 font-mono text-[10px] tracking-[0.2em] text-brand-muted hover:text-brand-forest transition-colors uppercase mb-4 group">
                <i data-lucide="arrow-left" width="12" height="12" class="group-hover:-translate-x-1 transition-transform"></i>
                Return
            </a>
            <h1 class="text-3xl md:text-4xl font-medium tracking-tight text-brand-text">Contract Visualizer</h1>
            <p class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase mt-2">Deal Cycle Mapping & Tracking</p>
        </div>
        
        <!-- Status Indicator -->
        <div class="flex items-center gap-3 mb-1">
            <div class="flex items-center gap-2 px-3 py-1 border border-brand-line bg-brand-surface font-mono text-[10px] tracking-widest text-brand-muted uppercase">
                <span id="active-maps-count">0</span> Maps Active
            </div>
            <button id="info-btn" class="ml-2 text-brand-muted hover:text-brand-forest transition-colors">
                <i data-lucide="info" width="18" height="18"></i>
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <main class="w-full max-w-7xl mx-auto reveal-up delay-200 flex-grow flex flex-col">
        
        <!-- Input Panel (Split Grid) -->
        <div class="bg-brand-line border border-brand-line industrial-shadow grid grid-cols-1 lg:grid-cols-2 gap-px relative mb-12">

            <!-- Section 1: Underlying Agreements -->
            <section class="bg-brand-base p-8 md:p-10">
                <h2 class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase flex items-center gap-2 mb-8">
                    <i data-lucide="layers" width="14" height="14" class="text-brand-text"></i>
                    01. Underlying Agreements
                </h2>
                <form id="underlying-form" class="space-y-8">
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-forest uppercase mb-2">Customer Name</label>
                            <input type="text" name="customerName" placeholder="e.g. Acme Corp" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text font-medium text-lg placeholder-brand-muted/40 focus:border-brand-forest transition-colors">
                        </div>
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-forest uppercase mb-2">Agreement Name</label>
                            <input type="text" name="name" placeholder="e.g. MSA 2023" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text font-medium text-lg placeholder-brand-muted/40 focus:border-brand-forest transition-colors">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Start Date</label>
                            <input type="date" name="startDate" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text text-sm font-mono focus:border-brand-forest transition-colors">
                        </div>
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">End Date</label>
                            <input type="date" name="endDate" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text text-sm font-mono focus:border-brand-forest transition-colors">
                        </div>
                    </div>

                    <div class="flex gap-6 items-end pt-2">
                        <div class="flex-1">
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Timeline Color</label>
                            <div class="flex gap-2" id="color-picker-container">
                                <!-- Color options injected by JS -->
                            </div>
                            <input type="hidden" name="color" id="underlying-color-input" value="brand">
                        </div>
                        <button type="submit" class="font-mono text-[10px] tracking-[0.2em] text-brand-text bg-brand-surface border border-brand-line hover:bg-brand-line transition-colors px-6 py-3 uppercase flex items-center gap-2">
                            <i data-lucide="plus" width="12" height="12"></i> Add Record
                        </button>
                    </div>
                </form>
            </section>

            <!-- Section 2: Map New Agreement -->
            <section class="bg-brand-base p-8 md:p-10 relative">
                <h2 class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase flex items-center gap-2 mb-8">
                    <i data-lucide="trending-up" width="14" height="14" class="text-brand-accent"></i>
                    02. Map New Agreement
                </h2>
                <form id="mapped-form" class="space-y-8">
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-accent uppercase mb-2">Customer Name</label>
                            <input type="text" name="customerName" placeholder="e.g. Acme Global" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text font-medium text-lg placeholder-brand-muted/40 focus:border-brand-accent transition-colors">
                        </div>
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-accent uppercase mb-2">Agreement Name</label>
                            <input type="text" name="name" placeholder="e.g. Consolidation" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text font-medium text-lg placeholder-brand-muted/40 focus:border-brand-accent transition-colors">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Start Date</label>
                            <input type="date" name="startDate" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text text-sm font-mono focus:border-brand-accent transition-colors">
                        </div>
                        <div>
                            <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">End Date</label>
                            <input type="date" name="endDate" required
                                class="w-full bg-transparent border-b border-brand-line py-2 text-brand-text text-sm font-mono focus:border-brand-accent transition-colors">
                        </div>
                    </div>

                    <div class="pt-2 flex justify-end">
                        <button type="submit" class="font-mono text-[10px] tracking-[0.2em] text-brand-base bg-brand-forest hover:bg-forest-700 transition-colors px-6 py-3 uppercase flex items-center gap-2">
                            <i data-lucide="arrow-right" width="12" height="12"></i> Map Deal
                        </button>
                    </div>
                </form>
            </section>
        </div>

        <!-- Visualizer Section -->
        <section id="visualizer-section" class="bg-brand-line border border-brand-line industrial-shadow flex flex-col gap-px relative transition-all duration-300">
            
            <!-- Controls Bar -->
            <div id="timeline-controls" class="bg-brand-base p-6 border-b border-brand-line flex justify-between items-center transition-all duration-300">
                <div class="flex items-center gap-3">
                    <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase font-bold">Timeline View</h3>
                    <div class="h-4 w-px bg-brand-line"></div>
                    <span class="font-mono text-[10px] tracking-widest text-brand-muted uppercase" id="view-range-label">Range: Auto-Fit</span>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="clear-all-btn" class="font-mono text-[10px] tracking-[0.2em] text-rust hover:bg-rust-tint transition-colors px-4 py-2 uppercase border border-transparent hidden">
                        Clear All
                    </button>
                </div>
            </div>
            
            <!-- Timeline Canvas -->
            <div id="timeline-canvas-container" class="bg-brand-base relative overflow-hidden min-h-[350px] w-full">
                <!-- Wrapper now forces fit, no scroll -->
                <div id="timeline-content-wrapper" class="w-full h-full p-8 pb-12 box-border transition-all duration-300">
                    <div id="timeline-container" class="relative h-full w-full">
                        <!-- Grid Lines Layer -->
                        <div id="grid-layer" class="absolute inset-0 w-full h-full pointer-events-none"></div>
                        <!-- Bars Layer -->
                        <div id="bars-layer" class="relative pt-12 space-y-3 z-10 w-full"></div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-brand-muted opacity-50">
                    <i data-lucide="layers" width="48" height="48" class="mb-4 text-brand-line"></i>
                    <p class="font-mono text-xs tracking-widest uppercase">System Ready / Awaiting Data</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto px-4 md:px-8 mt-12 mb-8 text-center reveal-up delay-300">
        <span class="font-mono text-[10px] tracking-[0.2em] text-brand-muted uppercase">
            Designed & Developed by <span class="text-brand-text font-medium">Jose Torres</span>
        </span>
    </footer>

    <!-- Global Tooltip (Spec Style) -->
    <div id="tooltip" class="fixed z-[220] pointer-events-none hidden transition-opacity duration-200" style="transform: translate(-50%, -100%);">
        <div class="bg-brand-text text-brand-base p-4 shadow-xl border border-brand-text/20 w-72 mb-3 relative">
            <div class="absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-brand-text rotate-45"></div>
            
            <div class="font-mono text-[10px] tracking-widest text-brand-line/60 uppercase mb-1" id="tooltip-category">Category</div>
            <div id="tooltip-name" class="font-medium text-sm text-brand-base mb-0.5">Name</div>
            <div id="tooltip-customer" class="text-xs text-brand-line/80 mb-3">Customer</div>
            
            <div class="border-t border-brand-line/20 pt-2 grid grid-cols-2 gap-4 font-mono text-[10px] text-brand-line/80">
                <div>
                    <span class="block opacity-50">Start</span>
                    <span id="tooltip-start" class="text-brand-base"></span>
                </div>
                <div class="text-right">
                    <span class="block opacity-50">End</span>
                    <span id="tooltip-end" class="text-brand-base"></span>
                </div>
            </div>
            
            <div id="tooltip-notes" class="text-xs text-brand-line/90 italic border-t border-brand-line/20 pt-2 mt-2 hidden"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 z-[210] flex items-center justify-center p-4 hidden">
        <div id="edit-modal-backdrop" class="absolute inset-0 bg-brand-text/10 backdrop-blur-sm transition-opacity"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-lg fade-in z-[211] industrial-shadow">
            <div class="px-6 py-4 border-b border-brand-line flex justify-between items-center bg-brand-surface">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="pencil" width="14" height="14"></i>
                    Edit Record
                </h3>
                <button id="close-edit-modal" class="text-brand-muted hover:text-brand-text transition-colors">
                    <i data-lucide="x" width="16" height="16"></i>
                </button>
            </div>
            <form id="edit-form" class="p-8 space-y-6">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-category">
                
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Customer</label>
                        <input type="text" id="edit-customerName" name="customerName" class="w-full bg-transparent border-b border-brand-line py-1 text-brand-text text-sm focus:border-brand-forest transition-colors">
                    </div>
                    <div>
                        <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Agreement</label>
                        <input type="text" id="edit-name" name="name" class="w-full bg-transparent border-b border-brand-line py-1 text-brand-text text-sm focus:border-brand-forest transition-colors">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Start Date</label>
                        <input type="date" id="edit-startDate" name="startDate" class="w-full bg-transparent border-b border-brand-line py-1 text-brand-text text-sm font-mono focus:border-brand-forest transition-colors">
                    </div>
                    <div>
                        <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">End Date</label>
                        <input type="date" id="edit-endDate" name="endDate" class="w-full bg-transparent border-b border-brand-line py-1 text-brand-text text-sm font-mono focus:border-brand-forest transition-colors">
                    </div>
                </div>

                <!-- Conditional Color Picker in Modal -->
                <div id="edit-color-section" class="hidden">
                    <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Timeline Color</label>
                    <div class="flex gap-2" id="edit-color-picker-container">
                        <!-- Colors injected by JS -->
                    </div>
                    <input type="hidden" id="edit-color-input" name="color">
                </div>

                <div>
                   <label class="block font-mono text-[10px] tracking-[0.15em] text-brand-muted uppercase mb-2">Notes</label>
                   <textarea id="edit-notes" name="notes" rows="3" class="w-full bg-brand-surface border border-brand-line p-3 text-brand-text text-sm focus:border-brand-forest transition-colors resize-none placeholder-brand-muted/50" placeholder="Add context..."></textarea>
                </div>

                <div class="flex gap-4 pt-4 border-t border-brand-line">
                    <button type="button" id="delete-from-modal" class="font-mono text-[10px] tracking-[0.2em] text-rust hover:bg-rust-tint px-4 py-2 uppercase border border-transparent transition-colors flex items-center gap-2">
                        <i data-lucide="trash-2" width="14" height="14"></i> Delete
                    </button>
                    <button type="submit" class="flex-1 font-mono text-[10px] tracking-[0.2em] text-brand-text bg-brand-surface border border-brand-line hover:bg-brand-line px-4 py-2 uppercase transition-colors">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Documentation Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-[210] hidden flex items-center justify-center p-4">
        <div id="info-backdrop" class="absolute inset-0 bg-brand-text/10 backdrop-blur-sm transition-opacity"></div>
        <div class="relative bg-brand-base border border-brand-line w-full max-w-lg fade-in z-50 industrial-shadow">
            <div class="px-6 py-4 border-b border-brand-line flex justify-between items-center bg-brand-surface">
                <h3 class="font-mono text-[10px] tracking-[0.2em] text-brand-text uppercase flex items-center gap-2">
                    <i data-lucide="file-text" width="14" height="14"></i>
                    Documentation
                </h3>
                <button id="close-info-btn" class="text-brand-muted hover:text-brand-text transition-colors">
                    <i data-lucide="x" width="16" height="16"></i>
                </button>
            </div>
            <div class="p-8 space-y-6 text-sm text-brand-text leading-relaxed">
                <div>
                    <h4 class="font-medium mb-2">System Objective</h4>
                    <p class="text-brand-muted">Visualizing overlapping contract terms and transaction history is critical for Deal Desk to prevent coverage gaps and ensure accurate revenue recognition. This tool standardizes the mapping of complex multi-agreement relationships.</p>
                </div>
                <div class="border-t border-brand-line pt-6">
                    <h4 class="font-medium mb-2">Rendering Logic</h4>
                    <p class="text-brand-muted">The timeline visualization automatically scales to fit the available viewport width, ensuring all agreements are visible in a single view without scrolling.</p>
                    <div class="bg-brand-surface p-4 mt-3 border border-brand-line font-mono text-[10px] tracking-wide text-center text-brand-text uppercase">
                        (Agreement Duration / Total Viewport Time) * 100%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="notification-container" class="fixed top-6 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script>
        lucide.createIcons();

        // Constants
        const PALETTE = [
            { id: 'brand', bg: 'bg-brand-text', border: 'border-black', label: 'Dark' },
            { id: 'forest', bg: 'bg-forest-700', border: 'border-forest-500', label: 'Forest' },
            { id: 'rust', bg: 'bg-rust', border: 'border-red-900', label: 'Rust' },
            { id: 'brass', bg: 'bg-brass', border: 'border-yellow-800', label: 'Brass' },
            { id: 'slate', bg: 'bg-slate', border: 'border-slate-700', label: 'Slate' },
            { id: 'blue', bg: 'bg-[#2563eb]', border: 'border-[#1d4ed8]', label: 'Blue' },
            { id: 'indigo', bg: 'bg-[#4f46e5]', border: 'border-[#4338ca]', label: 'Indigo' },
            { id: 'orange', bg: 'bg-[#f97316]', border: 'border-[#ea580c]', label: 'Orange' }
        ];

        // State
        let agreements = [
            { id: 1, category: 'underlying', customerName: 'Acme Corp', name: 'Original MSA', startDate: '2023-01-01', endDate: '2025-12-31', color: 'brand', notes: 'Superseded previous 2020 contract' },
            { id: 2, category: 'underlying', customerName: 'Acme Corp', name: 'Seat Expansion Q3', startDate: '2023-07-01', endDate: '2025-12-31', color: 'brass', notes: '' },
            { id: 3, category: 'mapped', customerName: 'Acme Corp', name: 'Global Consolidation', startDate: '2024-06-01', endDate: '2027-05-31', notes: 'Consolidating US and EMEA contracts' },
        ];

        let editingId = null;

        // --- Helpers ---

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric', day: 'numeric' });
        };

        const getTimelineStats = () => {
            if (agreements.length === 0) return null;
            const dates = agreements.flatMap(a => [new Date(a.startDate + 'T00:00:00'), new Date(a.endDate + 'T00:00:00')]);
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            // Add slight padding to timeline edges (1 month buffer)
            minDate.setMonth(minDate.getMonth() - 1);
            maxDate.setMonth(maxDate.getMonth() + 1);
            
            return { minDate, maxDate, totalDuration: maxDate - minDate };
        };

        const getPaletteColor = (id) => PALETTE.find(c => c.id === id) || PALETTE[0];

        // --- Component Renderers ---

        function renderColorPicker(containerId, inputId) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            container.innerHTML = '';

            PALETTE.forEach(color => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `w-6 h-6 rounded-full ${color.bg} border-2 transition-transform hover:scale-110 focus:outline-none`;
                
                // Active state check
                if (input.value === color.id) {
                    btn.classList.add('border-brand-text', 'ring-1', 'ring-brand-text', 'ring-offset-1');
                } else {
                    btn.classList.add('border-transparent');
                }

                btn.onclick = () => {
                    input.value = color.id;
                    renderColorPicker(containerId, inputId); // Re-render to update active state
                };
                
                container.appendChild(btn);
            });
        }

        // --- Notification System ---
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            
            let accentColor, iconName, bgColor;
            if (type === 'error') {
                accentColor = 'text-rust';
                bgColor = 'bg-rust';
                iconName = 'alert-triangle';
            } else if (type === 'success') {
                accentColor = 'text-forest-500';
                bgColor = 'bg-forest-700';
                iconName = 'check-circle';
            } else {
                accentColor = 'text-slate';
                bgColor = 'bg-slate';
                iconName = 'info';
            }

            notif.className = 'bg-brand-base border border-brand-line industrial-shadow p-4 w-80 pointer-events-auto flex gap-3 toast-enter relative overflow-hidden';
            
            notif.innerHTML = `
                <div class="absolute left-0 top-0 bottom-0 w-1 ${bgColor}"></div>
                <div class="${accentColor} mt-0.5 ml-1 shrink-0">
                    <i data-lucide="${iconName}" width="16" height="16"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-mono text-[10px] tracking-[0.15em] ${accentColor} uppercase mb-1">${title}</h4>
                    <p class="text-sm text-brand-text leading-snug">${message}</p>
                </div>
                <button class="text-brand-muted hover:text-brand-text transition-colors shrink-0 self-start" onclick="this.parentElement.remove()">
                    <i data-lucide="x" width="14" height="14"></i>
                </button>
            `;

            container.appendChild(notif);
            lucide.createIcons({ root: notif });

            setTimeout(() => {
                if(notif.parentElement) {
                    notif.classList.remove('toast-enter');
                    notif.classList.add('toast-exit');
                    setTimeout(() => notif.remove(), 300);
                }
            }, 4000);
        }

        // --- Rendering ---

        function renderApp() {
            document.getElementById('active-maps-count').textContent = agreements.length;
            renderTimeline();
            lucide.createIcons();
        }

        function renderTimeline() {
            const wrapper = document.getElementById('timeline-content-wrapper');
            const emptyState = document.getElementById('empty-state');
            const gridLayer = document.getElementById('grid-layer');
            const barsLayer = document.getElementById('bars-layer');
            const clearAllBtn = document.getElementById('clear-all-btn');

            gridLayer.innerHTML = '';
            barsLayer.innerHTML = '';

            if (agreements.length === 0) {
                emptyState.classList.remove('hidden');
                clearAllBtn.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            clearAllBtn.classList.remove('hidden');

            const stats = getTimelineStats();
            if (!stats) return;

            // Render Grid
            const current = new Date(stats.minDate);
            current.setDate(1);
            
            while (current < stats.maxDate) {
                const isYearStart = current.getMonth() === 0;
                const isQuarterStart = current.getMonth() % 3 === 0;
                const left = ((current - stats.minDate) / stats.totalDuration) * 100;

                if (left >= 0 && left <= 100) {
                    const line = document.createElement('div');
                    line.className = `absolute top-0 bottom-0 border-l ${isYearStart ? 'border-brand-line' : 'border-brand-line/20'} z-0`;
                    line.style.left = `${left}%`;
                    
                    let label = '';
                    if (isYearStart) {
                        label = `<span class="absolute top-2 left-1 font-mono text-[10px] text-brand-text font-bold">${current.getFullYear()}</span>`;
                    } else if (isQuarterStart) {
                        if ((stats.maxDate - stats.minDate) / (1000 * 60 * 60 * 24 * 365) < 5) {
                            label = `<span class="absolute top-2 left-1 font-mono text-[9px] text-brand-muted opacity-60">Q${Math.floor(current.getMonth() / 3) + 1}</span>`;
                        }
                    }
                    line.innerHTML = label;
                    gridLayer.appendChild(line);
                }
                current.setMonth(current.getMonth() + 1);
            }

            // Render Bars
            agreements.forEach(agreement => {
                const startDate = new Date(agreement.startDate + 'T00:00:00');
                const endDate = new Date(agreement.endDate + 'T00:00:00');
                
                const left = ((startDate - stats.minDate) / stats.totalDuration) * 100;
                const width = ((endDate - startDate) / stats.totalDuration) * 100;

                let barClasses = "";
                let textClass = "";
                let iconClass = "";

                if (agreement.category === 'mapped') {
                    // Mapped Agreement Styling (Ghost / Potential)
                    barClasses = "bg-brand-accent/20 border-2 border-dashed border-brand-accent";
                    textClass = "text-brand-text";
                    iconClass = "text-brand-text opacity-70";
                } else {
                    // Underlying Agreement Styling (Solid)
                    const colorData = getPaletteColor(agreement.color || 'brand');
                    barClasses = `${colorData.bg} border-l-4 border-r border-y ${colorData.border} shadow-md`;
                    textClass = "text-brand-base";
                    iconClass = "text-brand-base opacity-90";
                }

                const bar = document.createElement('div');
                bar.className = 'relative h-14 group transition-all duration-300 hover:-translate-y-1 hover:z-30 cursor-pointer w-full';
                bar.style.left = `${left}%`;
                bar.style.width = `${width}%`;
                
                bar.innerHTML = `
                    <div class="h-full flex flex-col justify-center px-3 relative overflow-hidden transition-all ${barClasses}">
                        <div class="flex items-center justify-between relative z-10 w-full h-full">
                            <div class="overflow-hidden flex-1 pointer-events-none pr-2">
                                <div class="flex items-center gap-2 mb-0.5">
                                    <span class="font-medium text-xs ${textClass} truncate leading-tight">${agreement.name}</span>
                                </div>
                                <div class="flex items-center gap-1.5 text-[10px] ${textClass} opacity-80 font-mono uppercase tracking-wide truncate">
                                    <span>${agreement.customerName || 'No Name'}</span>
                                    <span class="opacity-50">|</span>
                                    <span>${formatDate(agreement.startDate)} - ${formatDate(agreement.endDate)}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ml-1 flex-shrink-0 h-full">
                                <button class="edit-btn ${textClass} hover:opacity-100 p-1 transition-colors opacity-70" title="Edit">
                                    <i data-lucide="pencil" width="14" height="14"></i>
                                </button>
                                <button class="delete-btn ${textClass} hover:text-rust p-1 transition-colors opacity-70" title="Delete">
                                    <i data-lucide="trash-2" width="14" height="14"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Tooltip Events
                bar.addEventListener('mouseenter', (e) => showTooltip(e, agreement));
                bar.addEventListener('mouseleave', hideTooltip);

                // Button Events
                bar.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(agreement);
                });
                bar.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAgreement(agreement.id);
                });

                barsLayer.appendChild(bar);
            });
        }

        // --- Interaction Logic ---

        function addAgreement(formId, category) {
            const form = document.getElementById(formId);
            const formData = new FormData(form);
            
            const startDate = formData.get('startDate');
            const endDate = formData.get('endDate');

            if (new Date(endDate) < new Date(startDate)) {
                showNotification('Invalid Date Range', 'End date must be after start date.', 'error');
                return;
            }

            const newAgreement = {
                id: Date.now(),
                category: category,
                customerName: formData.get('customerName'),
                name: formData.get('name'),
                startDate: startDate,
                endDate: endDate,
                color: formData.get('color') || 'brand', // Capture color if present
                notes: ''
            };

            agreements.push(newAgreement);
            
            const customerName = formData.get('customerName');
            form.reset();
            form.querySelector('[name="customerName"]').value = customerName;
            
            // Reset color picker if it exists
            if (category === 'underlying') {
                document.getElementById('underlying-color-input').value = 'brand';
                renderColorPicker('color-picker-container', 'underlying-color-input');
            }

            renderApp();
            showNotification('Agreement Mapped', 'Timeline successfully created.', 'success');
        }

        function deleteAgreement(id) {
            agreements = agreements.filter(a => a.id !== id);
            if(editingId === id) closeEditModal();
            renderApp();
            showNotification('Record Deleted', 'Timeline removed from view.', 'info');
        }

        // --- Modal Logic ---

        function openEditModal(agreement) {
            hideTooltip();
            editingId = agreement.id;
            
            document.getElementById('edit-id').value = agreement.id;
            document.getElementById('edit-category').value = agreement.category;
            document.getElementById('edit-customerName').value = agreement.customerName;
            document.getElementById('edit-name').value = agreement.name;
            document.getElementById('edit-startDate').value = agreement.startDate;
            document.getElementById('edit-endDate').value = agreement.endDate;
            document.getElementById('edit-notes').value = agreement.notes || '';
            
            // Show/Hide Color Picker based on category
            const colorSection = document.getElementById('edit-color-section');
            if (agreement.category === 'underlying') {
                colorSection.classList.remove('hidden');
                document.getElementById('edit-color-input').value = agreement.color || 'brand';
                renderColorPicker('edit-color-picker-container', 'edit-color-input');
            } else {
                colorSection.classList.add('hidden');
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            editingId = null;
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function saveEdit(e) {
            e.preventDefault();
            if (!editingId) return;

            const category = document.getElementById('edit-category').value;
            
            const updated = {
                id: parseInt(document.getElementById('edit-id').value),
                customerName: document.getElementById('edit-customerName').value,
                name: document.getElementById('edit-name').value,
                startDate: document.getElementById('edit-startDate').value,
                endDate: document.getElementById('edit-endDate').value,
                notes: document.getElementById('edit-notes').value
            };

            if (category === 'underlying') {
                updated.color = document.getElementById('edit-color-input').value;
            }

            const index = agreements.findIndex(a => a.id === editingId);
            if (index !== -1) {
                agreements[index] = { ...agreements[index], ...updated };
            }

            closeEditModal();
            renderApp();
            showNotification('Changes Saved', 'Agreement details updated.', 'success');
        }

        // --- Tooltip Logic ---

        function showTooltip(e, agreement) {
            const tooltip = document.getElementById('tooltip');
            const rect = e.currentTarget.getBoundingClientRect();
            
            const categoryLabel = agreement.category === 'underlying' ? 'Underlying Agreement' : 'New Map';

            document.getElementById('tooltip-name').textContent = agreement.name;
            document.getElementById('tooltip-customer').textContent = agreement.customerName || '';
            document.getElementById('tooltip-start').textContent = formatDate(agreement.startDate);
            document.getElementById('tooltip-end').textContent = formatDate(agreement.endDate);
            document.getElementById('tooltip-category').textContent = categoryLabel.toUpperCase();
            
            const notesEl = document.getElementById('tooltip-notes');
            if (agreement.notes) {
                notesEl.textContent = `"${agreement.notes}"`;
                notesEl.classList.remove('hidden');
            } else {
                notesEl.classList.add('hidden');
            }
            
            tooltip.style.top = `${rect.top - 8}px`;
            tooltip.style.left = `${rect.left + (rect.width / 2)}px`;
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.add('hidden');
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // Initial Render of Color Picker in Underlying Form
            renderColorPicker('color-picker-container', 'underlying-color-input');
            
            renderApp();

            // Forms
            document.getElementById('underlying-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addAgreement('underlying-form', 'underlying');
            });
            document.getElementById('mapped-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addAgreement('mapped-form', 'mapped');
            });

            // Edit Modal
            document.getElementById('close-edit-modal').addEventListener('click', closeEditModal);
            document.getElementById('edit-modal-backdrop').addEventListener('click', closeEditModal);
            document.getElementById('edit-form').addEventListener('submit', saveEdit);
            document.getElementById('delete-from-modal').addEventListener('click', () => {
                if(editingId) deleteAgreement(editingId);
            });

            // Clear All
            document.getElementById('clear-all-btn').addEventListener('click', () => {
                if(confirm("Delete all timelines? This cannot be undone.")) {
                    agreements = [];
                    renderApp();
                    showNotification('Database Cleared', 'All records have been removed.', 'info');
                }
            });

            // Info Modal
            const infoBtn = document.getElementById('info-btn');
            const infoModal = document.getElementById('info-modal');
            const closeInfoBtn = document.getElementById('close-info-btn');
            const infoBackdrop = document.getElementById('info-backdrop');

            const toggleInfo = (show) => {
                if(show) infoModal.classList.remove('hidden');
                else infoModal.classList.add('hidden');
            };

            infoBtn.addEventListener('click', () => toggleInfo(true));
            closeInfoBtn.addEventListener('click', () => toggleInfo(false));
            infoBackdrop.addEventListener('click', () => toggleInfo(false));
        });

    </script>
</body>
</html>
