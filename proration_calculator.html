<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proration Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom number input styling */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-indigo-100 pb-20">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 relative z-40 shadow-sm sticky top-0">
        <div class="max-w-3xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 text-white p-2 rounded-lg">
                    <i data-lucide="calculator" width="24" height="24"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-900">Proration Calculator</h1>
                    <p class="text-sm text-slate-500">Co-Term & Add-on Pricing</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 text-sm font-medium">
                    <i data-lucide="calendar-check" width="14" height="14"></i>
                    <span>Deal Desk</span>
                </div>
                <button id="info-btn" class="p-2 text-slate-400 hover:text-fuchsia-600 hover:bg-fuchsia-50 rounded-lg transition-colors" title="Logic Explanation">
                    <i data-lucide="info" width="20" height="20"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-6 py-8 space-y-6">
        
        <!-- Inputs Section -->
        <section class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-fuchsia-500"></div>
            
            <!-- Dates -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Add-on Start Date</label>
                    <div class="relative">
                        <input type="date" id="start-date" 
                            class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-2 focus:ring-fuchsia-500/20 focus:border-fuchsia-500 block w-full p-3 outline-none transition-all">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Contract End Date</label>
                    <div class="relative">
                        <input type="date" id="end-date" 
                            class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-2 focus:ring-fuchsia-500/20 focus:border-fuchsia-500 block w-full p-3 outline-none transition-all">
                    </div>
                </div>
            </div>

            <!-- Pricing & Terms -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                <div class="md:col-span-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider">Pricing Input</label>
                        <select id="value-type" class="text-xs font-semibold text-fuchsia-700 bg-fuchsia-50 border border-fuchsia-100 rounded px-2 py-1 focus:ring-2 focus:ring-fuchsia-500 outline-none cursor-pointer">
                            <option value="ACV">Full Annual Value (ACV)</option>
                            <option value="TCV">Total Contract Value (TCV)</option>
                        </select>
                    </div>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-slate-400 font-semibold group-focus-within:text-fuchsia-500 transition-colors">$</span>
                        </div>
                        <input type="number" id="input-value" 
                            class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-xl font-bold rounded-lg focus:ring-2 focus:ring-fuchsia-500/20 focus:border-fuchsia-500 block w-full pl-8 p-3 transition-all outline-none" 
                            placeholder="0.00">
                    </div>
                    <p class="text-xs text-slate-400 mt-2" id="value-help-text">Enter the price for a full 12-month term.</p>
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Annual Uplift / CPI (%)</label>
                    <div class="relative">
                        <input type="number" id="uplift-percent" 
                            class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-sm rounded-lg focus:ring-2 focus:ring-fuchsia-500/20 focus:border-fuchsia-500 block w-full p-3 outline-none transition-all pr-8" 
                            value="5.0" step="0.1" min="0">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <span class="text-slate-400 text-xs font-bold">%</span>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1">Applied to renewals (Years 2+).</p>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <div id="results-container" class="hidden space-y-6 fade-in">
            
            <!-- Main Result Card (Stub) -->
            <div class="bg-gradient-to-br from-fuchsia-600 to-purple-700 rounded-xl shadow-lg p-8 text-white relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform duration-500">
                    <i data-lucide="receipt" width="100" height="100"></i>
                </div>
                
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6">
                    <div>
                        <div class="text-fuchsia-100 text-sm font-semibold uppercase tracking-wider mb-1">First Period Amount</div>
                        <div class="text-5xl font-bold tracking-tight" id="res-prorated">$0.00</div>
                        <div class="text-fuchsia-200 text-sm mt-2 font-medium">To be invoiced for current stub period</div>
                    </div>
                    
                    <div class="text-right bg-white/10 backdrop-blur-sm rounded-lg p-3 border border-white/10">
                        <div class="text-xs text-fuchsia-100 uppercase tracking-wide mb-1">First Period Duration</div>
                        <div class="text-2xl font-mono font-bold" id="res-percent">0%</div>
                    </div>
                </div>
            </div>

            <!-- Details Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-slate-400 mb-2"><i data-lucide="calendar-days" width="18" height="18"></i></div>
                    <div class="text-xl font-bold text-slate-800" id="res-days">0</div>
                    <div class="text-xs text-slate-500 font-medium uppercase">First Period Days</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div class="text-slate-400 mb-2"><i data-lucide="coins" width="18" height="18"></i></div>
                    <div class="text-xl font-bold text-slate-800" id="res-daily-rate">$0.00</div>
                    <div class="text-xs text-slate-500 font-medium uppercase">Daily Rate</div>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm col-span-2 md:col-span-1">
                    <div class="text-slate-400 mb-2"><i data-lucide="calendar-range" width="18" height="18"></i></div>
                    <div class="text-xl font-bold text-slate-800" id="res-total-months">0.0</div>
                    <div class="text-xs text-slate-500 font-medium uppercase">Total Duration (Months)</div>
                </div>
            </div>

            <!-- Subscription Fees Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-900 flex items-center gap-2">
                        <i data-lucide="table-2" class="text-fuchsia-500" width="20" height="20"></i>
                        Subscription Fee Schedule
                    </h3>
                    <div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">
                        Includes <span id="table-uplift-display">0%</span> annual uplift
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-semibold uppercase tracking-wider text-xs">
                            <tr>
                                <th class="px-6 py-3">Period</th>
                                <th class="px-6 py-3">Start Date</th>
                                <th class="px-6 py-3">End Date</th>
                                <th class="px-6 py-3 text-right">Fee</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="fee-schedule-body">
                            <!-- Rows generated by JS -->
                        </tbody>
                        <tfoot class="bg-fuchsia-50 font-bold text-slate-900">
                            <tr>
                                <td class="px-6 py-4" colspan="3">Total Contract Value (TCV)</td>
                                <td class="px-6 py-4 text-right text-fuchsia-700" id="res-tcv">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>

        <!-- Empty State -->
        <div id="empty-state" class="py-12 flex flex-col items-center justify-center text-center">
            <div class="bg-slate-100 p-4 rounded-full mb-4">
                <i data-lucide="calendar-plus" class="text-slate-300" width="40" height="40"></i>
            </div>
            <h3 class="text-lg font-medium text-slate-900 mb-1">Calculate Co-Term</h3>
            <p class="text-slate-500 text-sm max-w-sm">Enter the dates and value to calculate the year-over-year fees.</p>
        </div>

    </main>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div id="info-backdrop" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden fade-in z-50">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-900 flex items-center gap-2">
                    <i data-lucide="info" width="18" height="18" class="text-fuchsia-500"></i>
                    Calculation Logic
                </h3>
                <button id="close-info-btn" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" width="20" height="20"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 text-sm text-slate-600">
                <div class="space-y-2">
                    <h4 class="font-bold text-slate-800">Logic Overview</h4>
                    <p>This tool breaks the contract duration into <strong>annual periods</strong> aligned to the Contract End Date.</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>Stub Period:</strong> The tool places the partial year (stub) at the <em>beginning</em> of the term to align future invoices with your standard annual renewal cycle.</li>
                        <li><strong>Daily Rate:</strong> Calculated using a standard 365-day year basis (ACV รท 365).</li>
                    </ul>
                </div>

                <div class="space-y-2">
                    <h4 class="font-bold text-slate-800">Inputs</h4>
                    <ul class="list-disc pl-4 space-y-1">
                        <li><strong>ACV (Annual Contract Value):</strong> The price for one full year. Use this if you know the annual run rate.</li>
                        <li><strong>TCV (Total Contract Value):</strong> The total price for the entire duration. Use this if you have a lump sum budget you need to reverse-engineer.</li>
                    </ul>
                </div>

                <div class="space-y-2 border-t border-slate-100 pt-3">
                    <h4 class="font-bold text-slate-800">Industry Standard: Uplift & CPI</h4>
                    <p>Most SaaS contracts include an annual uplift clause to account for inflation (CPI) and product innovation.</p>
                    <div class="bg-slate-50 p-3 rounded border border-slate-200 text-xs">
                        <span class="font-semibold text-fuchsia-600">Recommendation:</span> 
                        Standard practice is <strong>CPI + 2%</strong> or a flat <strong>5-7%</strong> uplift cap. This calculator applies the uplift percentage to years 2, 3, etc.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Elements
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const inputValue = document.getElementById('input-value');
        const valueTypeSelect = document.getElementById('value-type');
        const valueHelpText = document.getElementById('value-help-text');
        const upliftPercentInput = document.getElementById('uplift-percent');
        
        const resultsContainer = document.getElementById('results-container');
        const emptyState = document.getElementById('empty-state');
        
        // Modal
        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const closeInfoBtn = document.getElementById('close-info-btn');
        const infoBackdrop = document.getElementById('info-backdrop');

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function updateHelpText() {
            const type = valueTypeSelect.value;
            if (type === 'ACV') {
                valueHelpText.textContent = "Enter the price for a full 12-month term.";
            } else {
                valueHelpText.textContent = "Enter the total contract value (Stub + Renewals).";
            }
            calculate();
        }

        function calculate() {
            const startVal = startDateInput.value;
            const endVal = endDateInput.value;
            const inputVal = parseFloat(inputValue.value);
            const valueType = valueTypeSelect.value;
            const uplift = parseFloat(upliftPercentInput.value) || 0;

            if (!startVal || !endVal || isNaN(inputVal)) {
                return;
            }

            const start = new Date(startVal + 'T00:00:00');
            const end = new Date(endVal + 'T00:00:00');

            if (end < start) return;

            // --- 1. Break down periods (Stub at front) ---
            // Strategy: Calculate standard annual periods starting from End Date backwards?
            // Or simpler: Align to End Date Month/Day.
            
            const periods = [];
            let currentStart = new Date(start);
            
            // Loop until we reach the end
            while (currentStart <= end) {
                // Find the next "Annual Cycle" end date.
                // The annual cycle aligns with the Final End Date.
                // So the boundaries are EndDate year-1, year-2, etc.
                // Actually, the simplest way to get "Stub at front" is:
                // Period 1 ends on the next occurrence of (EndMonth/EndDay)
                
                let nextCycleEnd = new Date(currentStart);
                nextCycleEnd.setMonth(end.getMonth());
                nextCycleEnd.setDate(end.getDate());
                
                // If the derived cycle end is before current start (e.g. Start is Nov, End is Oct), move to next year
                if (nextCycleEnd < currentStart) {
                    nextCycleEnd.setFullYear(nextCycleEnd.getFullYear() + 1);
                }
                
                // Ensure we don't go past the actual contract end
                if (nextCycleEnd > end) {
                    nextCycleEnd = new Date(end);
                }

                periods.push({
                    start: new Date(currentStart),
                    end: new Date(nextCycleEnd)
                });

                // Advance start to day after current period end
                currentStart = new Date(nextCycleEnd);
                currentStart.setDate(currentStart.getDate() + 1);
            }

            // --- 2. Calculate Factors for solving TCV/ACV ---
            // Base ACV applies to full years. Uplift applies cumulatively.
            // Stub is prorated off the Base ACV (Year 1 rate).
            
            let totalFactor = 0;
            const oneDay = 24 * 60 * 60 * 1000;
            
            // Prepare periods with their specific factors
            periods.forEach((p, index) => {
                const pDays = Math.round(Math.abs((p.end - p.start) / oneDay)) + 1;
                p.days = pDays;
                
                // Is this a full year? (Approx 365 or 366)
                // For simplified pricing logic, we usually treat subsequent full years as factor 1.0, 
                // and the first period as prorated if < 365.
                // However, strictly mathematically:
                
                const isFullYear = (p.end.getMonth() === end.getMonth() && p.end.getDate() === end.getDate()) &&
                                   (Math.abs(pDays - 365) <= 1); // tolerance for leap year
                
                let periodFactor = 0;
                
                // Determine Uplift Multiplier
                // Year 1 (Stub or Full) = Base Rate (1.0)
                // Year 2 = Base * (1 + Uplift)
                // Year 3 = Base * (1 + Uplift)^2
                const upliftMultiplier = Math.pow(1 + (uplift / 100), index); // Index 0 = 1.0
                
                if (index === 0 && !isFullYear) {
                    // Stub Logic: Prorate the Base Rate
                    const stubRatio = pDays / 365;
                    periodFactor = stubRatio * upliftMultiplier; // Usually uplift applies to full years, stub is base.
                    // If stub is at start, typically Stub is base rate prorated.
                    // So upliftMultiplier for index 0 is 1. Correct.
                } else {
                    // Full Year
                    periodFactor = 1.0 * upliftMultiplier;
                }
                
                p.factor = periodFactor;
                totalFactor += periodFactor;
            });

            // --- 3. Determine ACV ---
            let baseAcv = 0;
            if (valueType === 'ACV') {
                baseAcv = inputVal;
            } else {
                baseAcv = inputVal / totalFactor;
            }

            // --- 4. Generate UI Data ---
            let totalTCV = 0;
            const tableBody = document.getElementById('fee-schedule-body');
            tableBody.innerHTML = '';

            periods.forEach((p, index) => {
                const fee = baseAcv * p.factor;
                totalTCV += fee;
                
                const label = index === 0 && p.days < 360 ? "Year 1 (Stub)" : `Year ${index + 1}`;
                
                const rowHtml = `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-medium text-slate-900">${label}</td>
                        <td class="px-6 py-4 text-slate-500 font-mono text-xs">${formatDate(p.start)}</td>
                        <td class="px-6 py-4 text-slate-500 font-mono text-xs">${formatDate(p.end)}</td>
                        <td class="px-6 py-4 text-right font-bold text-slate-900">${fee.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                    </tr>
                `;
                tableBody.innerHTML += rowHtml;
            });

            // --- 5. Update Summary Cards (First Period) ---
            const firstP = periods[0];
            const firstFee = baseAcv * firstP.factor;
            const dailyRate = baseAcv / 365;
            
            // Total Duration calc
            const totalDays = Math.round(Math.abs((end - start) / oneDay)) + 1;
            const totalMonths = (totalDays / 30.44).toFixed(1);

            document.getElementById('res-prorated').textContent = firstFee.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            // Percent of a full year that the stub represents
            document.getElementById('res-percent').textContent = ((firstP.days / 365) * 100).toFixed(1) + '%';
            document.getElementById('res-days').textContent = firstP.days;
            document.getElementById('res-daily-rate').textContent = dailyRate.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('res-total-months').textContent = totalMonths;
            document.getElementById('table-uplift-display').textContent = uplift + '%';
            document.getElementById('res-tcv').textContent = totalTCV.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            resultsContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');
        }

        // Event Listeners
        startDateInput.addEventListener('input', calculate);
        endDateInput.addEventListener('input', calculate);
        inputValue.addEventListener('input', calculate);
        valueTypeSelect.addEventListener('change', updateHelpText);
        upliftPercentInput.addEventListener('input', calculate);

        // Modal Logic
        const toggleModal = (show) => {
            if (show) {
                infoModal.classList.remove('hidden');
                setTimeout(() => infoModal.firstElementChild.classList.remove('opacity-0'), 10);
            } else {
                infoModal.classList.add('hidden');
            }
        };

        infoBtn.addEventListener('click', () => toggleModal(true));
        closeInfoBtn.addEventListener('click', () => toggleModal(false));
        infoBackdrop.addEventListener('click', () => toggleModal(false));

    </script>
</body>
</html>